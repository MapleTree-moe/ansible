### {{ ansible_managed }} - {{ ansible_facts['fqdn'] }}
###
### mapletree.moe - podman quadlet file
### https://docs.podman.io/en/latest/markdown/podman-systemd.unit.5.html
###
### commit: {{ lookup('pipe', 'git rev-parse --short HEAD') }}

[Unit]
Description=Sonarr container
Documentation=https://github.com/Sonarr/Sonarr
After=podman-user-wait-network-online.service

[Service]
Restart=on-failure

[Container]
ContainerName=sonarr
Image={{ services['sonarr']['image'] }}
Network=frontend.network

# environmental variables
Environment=SONARR__APP__THEME=dark
Environment=SONARR__APP__INSTANCENAME=sonarr
Environment=SONARR__AUTH__METHOD=External
Environment=SONARR__AUTH__REQUIRED=DisabledForLocalAddresses
Environment=SONARR__SERVER__PORT=80

# health check
HealthCmd=curl http://127.0.0.1/ping
HealthInterval=5s
HealthRetries=3
HealthStartPeriod=15s
HealthTimeout=30s

# automatically configure traefik to proxy the web service
Label=traefik.enable="true"
Label=traefik.http.routers.sonarr.rule="Host(`sonarr.{{ ansible_facts['fqdn'] }}`)"
Label=traefik.http.routers.sonarr.middlewares="secured"
Label=traefik.http.services.sonarr.loadbalancer.server.port=80

# secrets
Secret=sonarr-api-key,type=env,target=SONARR__AUTH__APIKEY

# volumes
Volume=sonarr.volume:/config:Z
Volume=sonarr-backup.volume:/config/Backups:Z

[Install]
WantedBy=default.target
