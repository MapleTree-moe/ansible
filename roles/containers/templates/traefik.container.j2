# {{ ansible_managed }}
# {{ ansible_fqdn }}
# TODO: it would be nice to have the recent git commit here

[Container]
AutoUpdate=registry
ContainerName=traefik

# environmental variables
Environment=TRAEFIK_API="true"
Environment=TRAEFIK_PROVIDERS_DOCKER="true"
Environment=TRAEFIK_CERTIFICATESRESOLVERS_letsencrypt="true"
Environment=TRAEFIK_CERTIFICATESRESOLVERS_letsencrypt_ACME_EMAIL="{{ containers_traefik_acme_email }}"
Environment=TRAEFIK_CERTIFICATESRESOLVERS_letsencrypt_ACME_STORAGE="/etc/traefik/acme.json"
Environment=TRAEFIK_CERTIFICATESRESOLVERS_letsencrypt_ACME_TLSCHALLENGE="true"
Environment=TRAEFIK_ENTRYPOINTS_web_HTTP_REDIRECTIONS_ENTRYPOINT_TO="websecure"
Environment=TRAEFIK_ENTRYPOINTS_web_HTTP_REDIRECTIONS_ENTRYPOINT_SCHEME="https"
Environment=TRAEFIK_ENTRYPOINTS_web_HTTP_REDIRECTIONS_ENTRYPOINT_PERMANENT="true"
Environment=TRAEFIK_ENTRYPOINTS_websecure_HTTP2_MAXCONCURRENTSTREAMS="250"
Environment=TRAEFIK_ENTRYPOINTS_websecure_HTTP3="true"
Environment=TZ="Europe/Berlin"

Image=docker.io/traefik:v3.3

# labels for traefik autoconfiguration
Label=traefik.enable="true"
Label=traefik.http.routers.dashboard.rule="Host(`traefik.{{ ansible_fqdn }}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
Label=traefik.http.routers.dashboard.service="api@internal"
Label=traefik.http.routers.dashboard.middlewares="auth"
Label=traefik.http.routers.dashboard.tls="true"
Label=traefik.http.routers.dashboard.tls.certresolver="letsencrypt"
Label=traefik.http.middlewares.auth.basicauth.users="{{ containers_traefik_dashboard_user }}:{{ containers_traefik_dashboard_password | password_hash('bcrypt') }}"

Network=traefik.network

SecurityLabelType=traefik.process

Volume=/%t/podman/podman.sock:/var/run/docker.sock:ro
Volume=traefik.volume:/etc/traefik

[Service]
MemoryMax=512M
Restart=on-failure
Sockets=http.socket https.socket

[Install]
WantedBy=multi-user.target default.target

[Unit]
Description=Traefik container
Documentation=https://traefik.io
After=http.socket https.socket
Requires=http.socket https.socket
